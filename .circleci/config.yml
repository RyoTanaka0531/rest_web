version: 2
jobs:
  build:
    docker:
    machine:
      image: circleci/classic:edge

    working_directory: ~/rest-web

    steps:
      - checkout

      - run:
          name: image build
          command: |
            docker-compose up -d
            
      - run:
          name: docker-compose ps
          command: |
            docker-compose ps
      - run:
          name: sleee for DB launch
          command: |
            sleep 10

      - run:
          name: migrate db
          command: docker-compose run web rails db:create db:migrate

      - run:
          name: test
          command: |
            docker-compose exec web bundle exec  rspec ./spec/models/
            
      - run:
          name: docker tag
          command: |
            docker tag ${OWNER}/rest-web:latest ${OWNER}/rest-web:latest

      - run:
          name: docker login
          command: |
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
          
      - run:
          name: docker push
          command: |
            docker push ${OWNER}/rest-web

      - add_ssh_keys:
          fingerprints:
            - "d9:c3:96:88:96:90:cb:ae:4d:23:66:1e:a9:02:3d:56"
          
      - run:
          name: deploy to ec2
          command: |
            ssh ${HOST_NAME} 
            cd rest-web
            git pull
            docker-compose up -d

workflows:
      version: 2
      build-master:
        jobs:
          - build:
              filters:
                branches:
                  only: master